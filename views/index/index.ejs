<div class="container-fluid">

	<div class="row">
		<div class="col-sm-3 col-lg-2 offset-sm-6 offset-lg-0">
			<div class="card shadow my-3">
				<div class="card-body">
					Insira a Região
				</div>
			</div>
			<div class="card shadow my-1">
				<div class="card-body">
					Perto de mim (ativar)
				</div>
			</div>
		</div>
	</div>
</div>

<div id="mapa"></div>

<%- contentFor("espaco-head") %>

<link rel="stylesheet" href="/public/css/leaflet-1.7.1.css" />
<style type="text/css">
	#mapa {
		width: 100%;
		height: 400px;
	}
</style>

<%- contentFor("espaco-rodape") %>
<script type="text/javascript" src="/public/js/leaflet-1.7.1.js"></script>

<script type="text/javascript">
	let mapa = L.map("mapa", { zoomControl: false }),
		popup = L.popup();

	function onMarkerClick() {
		// Aqui dentro, this é o objeto marker que foi clicado.
		// Se quiser deixar vários popups abertos, é só ter um popup por marker,
		// diferente daqui, onde a gente reaproveita o objeto popup o tempo todo.

		let ponto = this.ponto;

		popup.setLatLng([ponto.lat, ponto.lng]);
		popup.setContent("<h1>" + ponto.nome + "</h1><p>" + ponto.descricao + "</p>");
		popup.openOn(mapa);
	}

	function listarPontos() {
		if ($.active)
			return;

		let highDpi = ("matchMedia" in window);
			icon = L.icon({
				iconUrl: (highDpi ? "/public/img/marker@2x.png" : "/public/img/marker.png"),
				iconSize: [25, 34],
				iconAnchor: [12, 34],
				popupAnchor: [0, 25]
			});

		highDpi = ((highDpi = window.matchMedia("(min-resolution: 150dpi)")) && highDpi.matches);

		let pontos = [
			{
				id: 1,
				nome: "Ponto 1",
				descricao: "Descrição do ponto 1",
				lat: -20.143484115600586,
				lng: -44.2154655456543
			},
			{
				id: 2,
				nome: "Ponto 2",
				descricao: "Descrição do ponto 2",
				lat: -20.142066955566406,
				lng: -44.214378356933594
			},
			{
				id: 3,
				nome: "Ponto 3",
				descricao: "Descrição do ponto 3",
				lat: -20.14223861694336,
				lng: -44.21717071533203
			}
		];

		for (var i = 0; i < pontos.length; i++) {
			var marker = L.marker([pontos[i].lat, pontos[i].lng], { icon: icon });
		
			marker.addTo(mapa);
			marker.ponto = pontos[i];
		
			marker.on("click", onMarkerClick);
		}
	}

	function iniciarMapa(lat, lng) {
		var latlng = new L.LatLng(lat, lng);

		L.control.zoom({
			position: "topright"
		}).addTo(mapa);

		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
			subdomains: ['a', 'b', 'c'],
			center: [latlng],
			minZoom: 10
		}).addTo(mapa);

		mapa.on("click", function (e) {
			popup.setLatLng([e.latlng.lat, e.latlng.lng]);
			popup.setContent("<p>Você clicou em " + e.latlng.lat.toFixed(8) + ", " + e.latlng.lng.toFixed(8) + "</p>");
			popup.openOn(mapa);
		});

		mapa.setView(latlng, 16);

		listarPontos();
	}

	iniciarMapa(-20.14348488422722, -44.2154639038087);

</script>
